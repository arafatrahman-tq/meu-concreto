version: "3.9"

# ==========================================
# DOCKER COMPOSE - MEU CONCRETO OS
# Otimizado para Coolify e deploy em produÃ§Ã£o
# ==========================================

services:
  # ServiÃ§o Ãºnico principal - Coolify gerencia este serviÃ§o
  meu-concreto:
    build:
      context: .
      dockerfile: Dockerfile
      target: release
    container_name: meu-concreto
    restart: unless-stopped

    # Porta exposta (Coolify detecta automaticamente)
    ports:
      - "${PORT:-3000}:3000"

    # VariÃ¡veis de ambiente
    environment:
      # ConfiguraÃ§Ãµes obrigatÃ³rias (Coolify preenche ou usa defaults)
      - NODE_ENV=${NODE_ENV:-production}
      - HOST=${HOST:-0.0.0.0}
      - PORT=${PORT:-3000}
      - DB_FILE_NAME=${DB_FILE_NAME:-/app/data/database.sqlite}

      # SeguranÃ§a (gerado automaticamente se nÃ£o fornecido)
      - AUTH_SECRET=${AUTH_SECRET}

      # APIs Externas (configurar no Coolify)
      - NUVEMFISCAL_CLIENT_ID=${NUVEMFISCAL_CLIENT_ID:-}
      - NUVEMFISCAL_CLIENT_SECRET=${NUVEMFISCAL_CLIENT_SECRET:-}
      - ASAAS_API_KEY=${ASAAS_API_KEY:-}
      - BLING_API_KEY=${BLING_API_KEY:-}
      - WHATSAPP_API_KEY=${WHATSAPP_API_KEY:-}
      - WHATSAPP_API_URL=${WHATSAPP_API_URL:-}
      - NUXT_PUBLIC_API_BASE=${NUXT_PUBLIC_API_BASE:-}

    # Volume persistente para o banco de dados
    volumes:
      - meu-concreto-data:/app/data

    # ConfiguraÃ§Ã£o de deploy
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service,environment"

    # Comando com inicializaÃ§Ã£o do banco
    command: >
      sh -c "
        echo 'ğŸ”§ Inicializando Meu Concreto OS...' &&
        
        # Gerar AUTH_SECRET se nÃ£o existir
        if [ -z \"\$AUTH_SECRET\" ]; then
          echo 'âš ï¸  AUTH_SECRET nÃ£o definido. Gerando...' &&
          export AUTH_SECRET=\$(openssl rand -base64 32 | tr -d '=+/') &&
          echo \"âœ… AUTH_SECRET gerado: \${AUTH_SECRET:0:10}...\" &&
          echo '   ğŸ’¡ Salve esta chave nas variÃ¡veis de ambiente do Coolify!';
        fi &&
        
        # Inicializar banco de dados se necessÃ¡rio
        echo 'ğŸ—„ï¸  Verificando banco de dados...' &&
        if [ ! -f \"\$DB_FILE_NAME\" ]; then
          echo 'ğŸ“¦ Banco nÃ£o encontrado. Criando e executando seed...' &&
          bunx drizzle-kit push &&
          bun server/database/seed-minimal.ts;
        else
          echo 'ğŸ“ Banco existente. Aplicando migrations...' &&
          bunx drizzle-kit push;
        fi &&
        
        echo 'ğŸš€ Iniciando aplicaÃ§Ã£o...' &&
        exec bun .output/server/index.mjs
      "

# Volume persistente
volumes:
  meu-concreto-data:
    driver: local
